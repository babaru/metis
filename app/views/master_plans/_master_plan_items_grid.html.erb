<%= grid(master_plan_items, :show_filters => :always) do |g|

  g.row_attributes do |master_plan_item|
      {class: 'master-plan-item-row'}
  end

  g.column name: t('activerecord.attributes.spot.channel_id') do |master_plan_item|
    master_plan_item.channel_name
  end

  g.column name: t('activerecord.attributes.spot.name') do |master_plan_item|
    link_to(
      content_tag(:strong, master_plan_item.reality_spot_name),
      '#',
      class: (master_plan_item.is_on_house ? 'is_on_house editable-field' : 'editable-field'),
      'data-type' => 'text',
      'data-pk' => master_plan_item.id,
      'data-name' => "reality_spot_name",
      'data-url' => modify_master_plan_item_path(master_plan_item),
      'data-original-title' => t('activerecord.attributes.spot.name'),
      'data-skip-pjax' => true
    )
  end

  g.column name: t('activerecord.attributes.master_plan_item.est_total_imp') do |master_plan_item|
    content_tag(:span, master_plan_item.est_total_imp, id: "master-plan-item-#{master_plan_item.id}-est-total-imp")
  end

  g.column name: t('activerecord.attributes.master_plan_item.est_total_clicks') do |master_plan_item|
    content_tag(:span, master_plan_item.est_total_clicks, id: "master-plan-item-#{master_plan_item.id}-est-total-clicks")
  end

  g.column name: t('activerecord.attributes.master_plan_item.est_imp') do |master_plan_item|
    link_to(master_plan_item.est_imp, '#', class: 'editable-field', 'data-type' => 'text', 'data-pk' => master_plan_item.id, 'data-name' => "est_imp", 'data-url' => "/master_plan_items/#{master_plan_item.id}/modify", 'data-original-title' => t('activerecord.attributes.master_plan_item.est_imp'), 'data-params' => "{'selected_medium_id': #{selected_medium_id}}", 'data-skip-pjax' => true)
  end

  g.column name: t('activerecord.attributes.master_plan_item.est_clicks') do |master_plan_item|
    link_to(master_plan_item.est_clicks, '#', class: 'editable-field', 'data-type' => 'text', 'data-pk' => master_plan_item.id, 'data-name' => "est_clicks", 'data-url' => "/master_plan_items/#{master_plan_item.id}/modify", 'data-original-title' => t('activerecord.attributes.master_plan_item.est_clicks'), 'data-params' => "{'selected_medium_id': #{selected_medium_id}}", 'data-skip-pjax' => true)
  end

  g.column name: t('activerecord.attributes.master_plan_item.est_ctr') do |master_plan_item|
    link_to(master_plan_item.est_ctr, '#', class: 'editable-field', 'data-type' => 'text', 'data-pk' => master_plan_item.id, 'data-name' => "est_ctr", 'data-url' => "/master_plan_items/#{master_plan_item.id}/modify", 'data-original-title' => "#{t('activerecord.attributes.master_plan_item.est_ctr')} (小数形式)", 'data-params' => "{'selected_medium_id': #{selected_medium_id}}", 'data-skip-pjax' => true, id: "master-plan-item-#{master_plan_item.id}-est-ctr")
  end

  g.column name: t('activerecord.attributes.spot.price') do |master_plan_item|
    "<strong>#{master_plan_item.unit_rate_card}</strong> #{master_plan_item.unit_rate_card_unit}".html_safe
  end

  g.column name: t('activerecord.attributes.master_plan_item.count') do |master_plan_item|
    [link_to(content_tag(:strong, master_plan_item.count), '#', class: 'master_plan_item_count', 'data-type' => 'text', 'data-pk' => master_plan_item.id, 'data-name' => "count", 'data-url' => "/master_plan_items/#{master_plan_item.id}/modify", 'data-original-title' => '输入数量', 'data-params' => "{'selected_medium_id': #{selected_medium_id}}", 'data-skip-pjax' => true), content_tag(:span, t('activerecord.spot.unit_type.day'))].join(' ').html_safe
  end

  g.column name: t('activerecord.attributes.master_plan_item.medium_policy') do |master_plan_item|
    content_tag(:div, [content_tag(:span, "#{master_plan_item.medium_discount}", class: 'medium value'),
      content_tag(:span, "#{master_plan_item.company_discount}", class: 'company value')].join(' ').html_safe, class: 'discounts', :style => master_plan_item.is_on_house ? 'display: none;' : '') if master_plan_item.spot_id
  end

  g.column name: t('activerecord.attributes.master_plan_item.net_cost') do |master_plan_item|
    content_tag(
      :div,
      [
        link_to(
          number_with_precision(master_plan_item.reality_medium_net_cost, precision: 0),
          '#',
          class: 'editable-field medium value',
          'data-type' => 'text',
          'data-pk' => master_plan_item.id,
          'data-name' => 'medium_net_cost',
          'data-url' => modify_master_plan_item_path(master_plan_item),
          'data-original-title' => '修改价格',
          'data-skip-pjax' => true
        ),
        link_to(
          number_with_precision(master_plan_item.reality_company_net_cost, precision: 0),
          '#',
          class: 'editable-field company value',
          'data-type' => 'text',
          'data-pk' => master_plan_item.id,
          'data-name' => 'company_net_cost',
          'data-url' => modify_master_plan_item_path(master_plan_item),
          'data-original-title' => '修改价格',
          'data-skip-pjax' => true
        )
      ].join(' ').html_safe, class: 'discounts', :style => master_plan_item.is_on_house ? 'display: none;' : '')
  end

  g.column :html => {class: 'buttons'} do |master_plan_item|
    master_plan_item.is_on_house ? link_to(render_icon_content('icon-dollar'), '#', 'data-id' => master_plan_item.id, 'data-value' => false, 'data-medium-id' => selected_medium_id, class: 'master_plan_item_is_on_house button button-inverse', 'data-skip-pjax' => true, rel: 'tooltip', title: '转成购买') : link_to(render_icon_content('icon-thumbs-up'), '#', 'data-id' => master_plan_item.id, 'data-medium-id' => selected_medium_id, class: 'master_plan_item_is_on_house button', 'data-value' => true, 'data-skip-pjax' => true, rel: 'tooltip', title: '转成配送') if master_plan_item.spot_id && !master_plan_item.spot.is_a?(NetCostSpot)
  end

  g.column :html => {class: 'buttons'} do |master_plan_item|
    link_to(render_icon_content('icon-remove'), master_plan_item_path(master_plan_item), :method => :delete, :confirm => t("confirms.delete"), :class => 'button icon button-danger', :rel => 'tooltip', :title => t('buttons.delete'), "data-skip-pjax" => true)
  end
end -%>

<%= content_tag :span, @selected_medium_id, class: 'hide', id: 'selected-medium-id-value' %>
<%= content_tag :span, @master_plan.id, class: 'hide', id: 'master-plan-id-value' %>

<script type="text/javascript">
$(document).ready(function() {
  $('.master_plan_item_count').editable({
    success: function(data) {
      update_master_plan_summary();
    }
  });

  $('.editable-field').editable({
    success: function(data) {
      update_total_fields(data);
    }
  });

  $('.master_plan_item_is_on_house').click(function() {
    var item_id = $(this).data('id');
    var medium_id = $(this).data('medium-id');
    var val = $(this).data('value');
    var button = $(this);
    $.ajax({
      url: '/master_plan_items/' + item_id + '/modify?selected_medium_id=' + medium_id,
      type: 'POST',
      data: {
        name: 'is_on_house',
        value: val
      },
      success: function(data) {
        update_summary(data);
        var is_on_house = false;
        if(data["is_on_house"] == true) is_on_house = true;
        switch_button(is_on_house, button);
        update_grid(is_on_house, button);
      },
    });
  })
});

function update_summary(data) {
  $('.master-plan-summary .contract_price').text(data["medium_contract_price"] + ' (' + data['contract_price'] + ')');
  $('.master-plan-summary .profit').text(data["medium_profit"] + ' (' + data['profit'] + ')');
  // $('.master-plan-summary .bonus_ratio').text(data["medium_"]);
}

function update_total_fields(data) {
  $('#master-plan-item-' + data['id'] + '-est-total-imp').text(data["est_total_imp"]);
  $('#master-plan-item-' + data['id'] + '-est-total-clicks').text(data["est_total_clicks"]);
  $('#master-plan-item-' + data['id'] + '-est-ctr').text(data["est_ctr"]);
}

function switch_button(is_on_house, button) {
  if (is_on_house) {
    button.data('value', false).addClass('button-success');
  } else {
    button.data('value', true).removeClass('button-success');
  }
}

function update_grid(is_on_house, button) {
  if (is_on_house) {
    button.parent().parent().find('.discounts').hide();
  } else {
    button.parent().parent().find('.discounts').show();
  }
}

</script>
